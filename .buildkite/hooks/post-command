#!/usr/bin/env bash

(
  BUILDEVENT_APIKEY=$CI_BUILDEVENT_API_KEY
  BUILDEVENT_DATASET=buildkite 
  export BUILDEVENT_DATASET
  export BUILDEVENT_APIKEY

  ./buildevents step "$BUILDKITE_BUILD_ID" "$BUILDKITE_STEP_ID" "$STEP_START" "$BUILDKITE_STEP_KEY"

  if [ $BUILDKITE_COMMAND_EXIT_STATUS -ne 0 ]; then
    ./buildevents build "$BUILDKITE_BUILD_ID" "$BUILD_START_TIME" failure
  fi
)
